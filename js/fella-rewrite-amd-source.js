// Generated by CoffeeScript 1.7.1
var cat, drop, find_head_end_idx, fn, inc, index_of, map, partial, remove_indent, rewrite, rewrite_head, str_join, str_split, tail, take;

fn = require('f-empower');

rewrite_head = require('./fella-rewrite-head');

cat = fn.cat, drop = fn.drop, inc = fn.inc, index_of = fn.index_of, map = fn.map, partial = fn.partial, str_join = fn.str_join, str_split = fn.str_split, tail = fn.tail, take = fn.take;

find_head_end_idx = function(lines) {
  var idx, item, _i, _len, _ref;
  idx = -1;
  _ref = [') ->', 'define ->'];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    item = _ref[_i];
    idx = index_of(item, lines);
    if (idx !== -1) {
      return idx;
    }
  }
  return idx;
};

remove_indent = function(lines) {
  return map(partial(tail, 2), lines);
};

rewrite = function(amd_headed_source) {
  var commonjs_lines, commonjs_source, head_end_idx, head_lines, lines, rest_lines;
  lines = str_split('\n', amd_headed_source);
  head_end_idx = find_head_end_idx(lines);
  head_lines = take(inc(head_end_idx), lines);
  rest_lines = remove_indent(drop(inc(head_end_idx), lines));
  commonjs_lines = cat(rewrite_head(head_lines), rest_lines);
  return commonjs_source = str_join('\n', commonjs_lines);
};

module.exports = rewrite;
